{% macro render_thumbnail(parent, thumbnail_size=None) -%}
    {% set thumb = parent.thumbnail(thumbnail_size) %}
    {% if thumb %}
        <a href="{{parent.link}}">
            <img class="preview" src="{{thumb.src}}"
                {% if thumb.width %}width="{{thumb.width}}"{% endif %}
                {% if thumb.height %} height="{{thumb.height}}"{% endif %} />
        </a>
    {% else %}
        <!-- no preview available -->
    {% endif %}
{%- endmacro %}

{% macro render_message(message, preview_size) -%}
    <div class="message-container{%if message.subtype %} {{message.subtype}}{%endif%}">
        <div id="{{ message.id }}">
            <img src="{{ message.img }}" class="user_icon" />
            <div class="message">
                <div class="username">{{ message.username }}</div>
                <a href="#{{ message.id}}"><div class="time">{{ message.time }}</div></a>
                <div class="msg">
                    {{ message.msg|safe }}
                    {% for attachment in message.attachments -%}
                        <div class="message-attachment">
                            {%if attachment.service_name %}<div class="service-name">{{ attachment.service_name }}</div>{%endif%}
                            <div class="link-title"><a href="{{ attachment.title_link }}">{{ attachment.title }}</a></div>
                            <div class="link-text">{{attachment.text}}</div>
                            {{ render_thumbnail(attachment, preview_size) }}
                            {% if attachment.original_url %}
                                <div class="print-only">Original URL: {{attachment.original_url}}</div>
                            {% endif %}
                        </div>
                    {% endfor  %}
                    {% for file in message.files  -%}
                        <div class="message-upload">
                            <div class="link-title"><a href="{{ file.link }}">{{ file.title }}</a></div>
                            {{ render_thumbnail(file, preview_size) }}
                        </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
{%- endmacro %}
